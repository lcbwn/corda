<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd"
                   logicalFilePath="migration/node-services.changelog-init.xml">

    <changeSet author="R3.Corda" id="add_new_checkpoint_schema_primary_keys">
        <addPrimaryKey columnNames="flow_id" constraintName="node_checkpoints_pk" tableName="node_checkpoints"/>
        <addPrimaryKey columnNames="id" constraintName="node_checkpoint_blobs_pk" tableName="node_checkpoint_blobs"/>
        <addPrimaryKey columnNames="id" constraintName="node_checkpoint_exceptions_pk" tableName="node_flow_exceptions"/>
        <addPrimaryKey columnNames="id" constraintName="node_checkpoint_results_pk" tableName="node_flow_results"/>
        <addPrimaryKey columnNames="invocation_id" constraintName="node_flow_metadata_pk" tableName="node_flow_metadata"/>
    </changeSet>

    <changeSet author="R3.Corda" id="add_new_checkpoint_schema_foreign_keys">
        <addForeignKeyConstraint baseColumnNames="checkpoint_blob_id" baseTableName="node_checkpoints"
                                 constraintName="node_checkpoint_blob_id_to_blob_table_fk"
                                 referencedColumnNames="id" referencedTableName="node_checkpoint_blobs"/>

        <addForeignKeyConstraint baseColumnNames="error_id" baseTableName="node_checkpoints"
                                 constraintName="node_checkpoints_to_exceptions_fk"
                                 referencedColumnNames="id" referencedTableName="node_flow_exceptions"/>

        <addForeignKeyConstraint baseColumnNames="result_id" baseTableName="node_checkpoints"
                                 constraintName="node_checkpoint_to_result_fk"
                                 referencedColumnNames="id" referencedTableName="node_flow_results"/>

        <addForeignKeyConstraint baseColumnNames="flow_id" baseTableName="node_flow_metadata"
                                 constraintName="node_metadata_to_checkpoints_fk"
                                 referencedColumnNames="flow_id" referencedTableName="node_checkpoints"/>

    </changeSet>

</databaseChangeLog>